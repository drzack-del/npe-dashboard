<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>North Tampa Braces - NPE Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body style="margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Simple localStorage wrapper for storage
        const storage = {
            get: async (key) => {
                const value = localStorage.getItem(key);
                return value ? { value } : null;
            },
            set: async (key, value) => {
                localStorage.setItem(key, value);
                return { value };
            },
            delete: async (key) => {
                localStorage.removeItem(key);
            }
        };
        
        // Main Dashboard Component
        const NPEDashboard = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [rememberMe, setRememberMe] = useState(false);
            const [currentView, setCurrentView] = useState('dashboard');
            const [patients, setPatients] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const checkAuth = async () => {
                    const result = await storage.get('npe-auth');
                    if (result && result.value === 'authenticated') {
                        setIsAuthenticated(true);
                    }
                };
                checkAuth();
            }, []);

            useEffect(() => {
                const loadData = async () => {
                    const result = await storage.get('npe-patients');
                    if (result && result.value) {
                        setPatients(JSON.parse(result.value));
                    }
                    setLoading(false);
                };
                if (isAuthenticated) {
                    loadData();
                }
            }, [isAuthenticated]);

            const saveData = async (newPatients) => {
                await storage.set('npe-patients', JSON.stringify(newPatients));
                setPatients(newPatients);
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if (password === 'Glastron410##') {
                    setIsAuthenticated(true);
                    if (rememberMe) {
                        await storage.set('npe-auth', 'authenticated');
                    }
                } else {
                    alert('Incorrect password');
                }
            };

            const handleLogout = async () => {
                setIsAuthenticated(false);
                await storage.delete('npe-auth');
            };

            if (!isAuthenticated) {
                return (
                    <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',backgroundColor:'#002F5D'}}>
                        <div style={{backgroundColor:'white',padding:'32px',borderRadius:'8px',boxShadow:'0 10px 25px rgba(0,0,0,0.2)',maxWidth:'400px',width:'100%'}}>
                            <div style={{textAlign:'center',marginBottom:'24px'}}>
                                <h1 style={{fontSize:'28px',fontWeight:'bold',marginBottom:'8px',color:'#002F5D'}}>North Tampa Braces</h1>
                                <h2 style={{fontSize:'20px',color:'#FF6B35'}}>NPE Dashboard</h2>
                            </div>
                            <form onSubmit={handleLogin}>
                                <div style={{marginBottom:'16px'}}>
                                    <label style={{display:'block',fontSize:'14px',fontWeight:'500',marginBottom:'8px'}}>Password</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        style={{width:'100%',padding:'8px 12px',border:'1px solid #ddd',borderRadius:'4px',fontSize:'14px'}}
                                        placeholder="Enter password"
                                    />
                                </div>
                                <div style={{display:'flex',alignItems:'center',marginBottom:'16px'}}>
                                    <input
                                        type="checkbox"
                                        id="rememberMe"
                                        checked={rememberMe}
                                        onChange={(e) => setRememberMe(e.target.checked)}
                                        style={{width:'16px',height:'16px'}}
                                    />
                                    <label htmlFor="rememberMe" style={{marginLeft:'8px',fontSize:'14px'}}>Remember me</label>
                                </div>
                                <button
                                    type="submit"
                                    style={{width:'100%',padding:'10px',backgroundColor:'#FF6B35',color:'white',border:'none',borderRadius:'4px',fontSize:'16px',fontWeight:'500',cursor:'pointer'}}
                                >
                                    Login
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{minHeight:'100vh',backgroundColor:'#f9fafb'}}>
                    <header style={{backgroundColor:'#002F5D',boxShadow:'0 1px 3px rgba(0,0,0,0.1)'}}>
                        <div style={{maxWidth:'1280px',margin:'0 auto',padding:'16px'}}>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                <div>
                                    <h1 style={{fontSize:'24px',fontWeight:'bold',color:'white'}}>North Tampa Braces</h1>
                                    <p style={{fontSize:'14px',color:'#FF6B35'}}>NPE Dashboard</p>
                                </div>
                                <button
                                    onClick={handleLogout}
                                    style={{padding:'8px 16px',backgroundColor:'transparent',color:'white',border:'none',borderRadius:'4px',cursor:'pointer',fontSize:'14px'}}
                                >
                                    Logout
                                </button>
                            </div>
                        </div>
                    </header>

                    <nav style={{backgroundColor:'white',borderBottom:'1px solid #e5e7eb'}}>
                        <div style={{maxWidth:'1280px',margin:'0 auto',padding:'0 16px'}}>
                            <div style={{display:'flex',gap:'4px',overflowX:'auto'}}>
                                {['dashboard', 'import'].map((view) => (
                                    <button
                                        key={view}
                                        onClick={() => setCurrentView(view)}
                                        style={{
                                            padding:'12px 16px',
                                            fontWeight:'500',
                                            fontSize:'14px',
                                            whiteSpace:'nowrap',
                                            border:'none',
                                            borderBottom: currentView === view ? '2px solid #FF6B35' : '2px solid transparent',
                                            color: currentView === view ? '#002F5D' : '#6b7280',
                                            backgroundColor:'transparent',
                                            cursor:'pointer'
                                        }}
                                    >
                                        {view === 'dashboard' && 'üìä Dashboard'}
                                        {view === 'import' && 'üì• Import CSV'}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main style={{maxWidth:'1280px',margin:'0 auto',padding:'24px 16px'}}>
                        {loading ? (
                            <div style={{textAlign:'center',padding:'48px'}}>
                                <div style={{fontSize:'20px',color:'#6b7280'}}>Loading...</div>
                            </div>
                        ) : (
                            <>
                                {currentView === 'dashboard' && <Dashboard patients={patients} />}
                                {currentView === 'import' && <Import patients={patients} saveData={saveData} />}
                            </>
                        )}
                    </main>
                </div>
            );
        };

        // Dashboard Component
        const Dashboard = ({ patients }) => {
            const total = patients.length;
            const started = patients.filter(p => p.ST).length;
            const pending = patients.filter(p => p.PEN).length;
            const conv = total > 0 ? Math.round((started / total) * 100) : 0;

            return (
                <div style={{display:'flex',flexDirection:'column',gap:'24px'}}>
                    <h2 style={{fontSize:'30px',fontWeight:'bold',color:'#002F5D'}}>Dashboard</h2>
                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'16px'}}>
                        <div style={{backgroundColor:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'24px'}}>
                            <div style={{fontSize:'14px',color:'#6b7280',marginBottom:'4px'}}>Total Patients</div>
                            <div style={{fontSize:'30px',fontWeight:'bold',color:'#002F5D'}}>{total}</div>
                        </div>
                        <div style={{backgroundColor:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'24px'}}>
                            <div style={{fontSize:'14px',color:'#6b7280',marginBottom:'4px'}}>Started</div>
                            <div style={{fontSize:'30px',fontWeight:'bold',color:'#10b981'}}>{started}</div>
                        </div>
                        <div style={{backgroundColor:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'24px'}}>
                            <div style={{fontSize:'14px',color:'#6b7280',marginBottom:'4px'}}>Conversion</div>
                            <div style={{fontSize:'30px',fontWeight:'bold',color:'#FF6B35'}}>{conv}%</div>
                        </div>
                        <div style={{backgroundColor:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'24px'}}>
                            <div style={{fontSize:'14px',color:'#6b7280',marginBottom:'4px'}}>Pending</div>
                            <div style={{fontSize:'30px',fontWeight:'bold',color:'#ef4444'}}>{pending}</div>
                        </div>
                    </div>
                    {pending > 0 && (
                        <div style={{backgroundColor:'#fff7ed',borderLeft:'4px solid #f97316',padding:'16px',borderRadius:'4px'}}>
                            <p style={{fontWeight:'bold',color:'#9a3412'}}>‚ö†Ô∏è {pending} patient{pending !== 1 ? 's' : ''} need follow-up</p>
                        </div>
                    )}
                    {total === 0 && (
                        <div style={{backgroundColor:'#dbeafe',border:'1px solid #93c5fd',padding:'16px',borderRadius:'8px'}}>
                            <p style={{fontWeight:'bold',color:'#1e40af',marginBottom:'8px'}}>üìå No Data Yet</p>
                            <p style={{fontSize:'14px',color:'#1e3a8a'}}>
                                Go to the "üì• Import CSV" tab to upload your patient data.
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        // Import Component
        const Import = ({ patients, saveData }) => {
            const [status, setStatus] = useState('');
            const [preview, setPreview] = useState(null);

            const parseDate = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const month = parts[0].padStart(2, '0');
                    const day = parts[1].padStart(2, '0');
                    const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    return `${year}-${month}-${day}`;
                }
                return dateStr;
            };

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const text = evt.target.result;
                        const rows = text.split('\n').map(row => {
                            const matches = row.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                            return matches ? matches.map(cell => cell.replace(/^"|"$/g, '').trim()) : [];
                        });

                        const data = rows.slice(1).filter(row => row.length > 1 && row[0]).map((row, idx) => ({
                            id: Date.now() + idx,
                            name: row[0] || '',
                            npeDate: parseDate(row[1]) || new Date().toISOString().split('T')[0],
                            location: row[2] || 'Car',
                            startDate: parseDate(row[3]) || '',
                            dp: row[4] || '',
                            obstacle: row[5] || '',
                            notes: row[6] || '',
                            BR: row[7] === 'X',
                            INV: row[8] === 'X',
                            PH1: row[9] === 'X',
                            PH2: row[10] === 'X',
                            LTD: row[11] === 'X',
                            PIF: row[12] === 'X',
                            'R+': row[13] === 'X',
                            'W+': row[14] === 'X',
                            ST: row[15] === 'X',
                            SCH: row[16] === 'X',
                            OBS: row[17] === 'X',
                            PEN: row[18] === 'X',
                            MP: row[19] === 'X',
                            NOTX: row[20] === 'X',
                            DR: false,
                            RO: false,
                            contactAttempts: 0,
                            lastContactDate: null,
                            nextTouchDate: (row[18] === 'X' || row[16] === 'X') ? new Date(Date.now() + 86400000).toISOString().split('T')[0] : null,
                            contactHistory: [],
                            createdAt: new Date().toISOString()
                        }));

                        setPreview(data);
                        setStatus(`Found ${data.length} patients`);
                    } catch (error) {
                        setStatus(`Error: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            };

            const doImport = () => {
                if (!preview) return;
                saveData([...patients, ...preview]);
                setStatus(`Imported ${preview.length} patients successfully!`);
                setPreview(null);
            };

            return (
                <div style={{display:'flex',flexDirection:'column',gap:'24px'}}>
                    <h2 style={{fontSize:'30px',fontWeight:'bold',color:'#002F5D'}}>Import Patient Data</h2>
                    <div style={{backgroundColor:'#dbeafe',border:'1px solid #93c5fd',padding:'16px',borderRadius:'8px'}}>
                        <p style={{fontWeight:'bold',color:'#1e40af',marginBottom:'8px'}}>üìå How to Import</p>
                        <ol style={{fontSize:'14px',color:'#1e3a8a',paddingLeft:'20px'}}>
                            <li>Export your NPE tracker from Google Sheets as CSV</li>
                            <li>Click "Choose File" below</li>
                            <li>Review the preview</li>
                            <li>Click "Import"</li>
                        </ol>
                    </div>
                    <div style={{backgroundColor:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'24px'}}>
                        <input
                            type="file"
                            accept=".csv"
                            onChange={handleFile}
                            style={{marginBottom:'16px'}}
                        />
                        {status && (
                            <div style={{padding:'16px',backgroundColor:'#dbeafe',borderRadius:'4px',marginBottom:'16px'}}>
                                {status}
                            </div>
                        )}
                        {preview && (
                            <div>
                                <h3 style={{fontWeight:'bold',marginBottom:'8px'}}>Preview ({preview.length} patients)</h3>
                                <div style={{maxHeight:'256px',overflowY:'auto',border:'1px solid #e5e7eb',borderRadius:'4px',marginBottom:'16px'}}>
                                    <table style={{width:'100%',fontSize:'14px'}}>
                                        <thead style={{backgroundColor:'#f9fafb'}}>
                                            <tr>
                                                <th style={{padding:'8px 16px',textAlign:'left'}}>Name</th>
                                                <th style={{padding:'8px 16px',textAlign:'left'}}>NPE Date</th>
                                                <th style={{padding:'8px 16px',textAlign:'left'}}>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {preview.slice(0, 10).map((p, i) => (
                                                <tr key={i}>
                                                    <td style={{padding:'8px 16px'}}>{p.name}</td>
                                                    <td style={{padding:'8px 16px'}}>{p.npeDate}</td>
                                                    <td style={{padding:'8px 16px'}}>
                                                        {p.ST ? 'üü¢' : p.SCH ? 'üîµ' : p.PEN ? 'üü†' : '-'}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <button
                                    onClick={doImport}
                                    style={{padding:'12px 24px',backgroundColor:'#FF6B35',color:'white',border:'none',borderRadius:'4px',fontSize:'16px',fontWeight:'500',cursor:'pointer'}}
                                >
                                    Import {preview.length} Patients
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<NPEDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
